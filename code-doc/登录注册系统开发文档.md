# 登录注册系统开发文档

## 项目概述

该项目实现了一个完整的登录注册系统，支持多种认证方式，包括邮箱登录、微信登录等。系统采用适配器模式，支持中国区和国际区的不同认证服务。

## 技术架构

### 核心技术栈
- **前端框架**: Next.js 14.2.16 (React 18)
- **UI组件库**: Radix UI + Tailwind CSS
- **认证库**: NextAuth.js 4.24.11
- **数据库**: 腾讯云 CloudBase (国内) / Supabase (国际)
- **状态管理**: React Context + NextAuth Session
- **表单处理**: React Hook Form + Zod

### 项目结构
```
src/
├── app/                          # Next.js App Router
│   ├── login/page.tsx           # 登录页面
│   ├── register/page.tsx        # 注册页面
│   └── auth/wechat-callback/    # 微信登录回调
├── components/                   # React 组件
│   ├── auth-provider.tsx        # 认证提供者
│   ├── wechat-login-button.tsx  # 微信登录按钮
│   └── ui/                      # UI 组件库
├── lib/                         # 核心库
│   ├── auth/                    # 认证模块
│   │   ├── adapter.ts           # 认证适配器
│   │   ├── client.ts            # 认证客户端
│   │   └── index.ts             # 统一导出
│   ├── core/                    # 核心类型和接口
│   ├── config/                  # 配置文件
│   └── utils/                   # 工具函数
└── api/                         # API 路由
    ├── auth/                    # 认证相关 API
    └── register.ts              # 注册 API
```

## 功能特性

### 1. 邮箱登录注册
- 支持邮箱密码登录
- 支持邮箱密码注册
- 密码强度验证（至少6位）
- 邮箱格式验证
- 错误提示和加载状态

### 2. 微信登录
- 支持微信扫码登录（PC端）
- 支持微信内置浏览器登录（移动端）
- QR码生成和轮询机制
- 登录状态实时检测

### 3. 多区域适配
- 中国区：腾讯云 CloudBase + 微信登录
- 国际区：Supabase Auth + OAuth (Google/GitHub)
- 自动区域检测和适配

### 4. 安全特性
- 密码加密存储（bcrypt）
- JWT Token 认证
- 会话管理
- CSRF 防护

## 核心模块详解

### 1. 认证适配器 (lib/auth/adapter.ts)

采用适配器模式，统一不同认证服务的接口：

```typescript
interface AuthAdapter {
  signInWithEmail(email: string, password: string): Promise<AuthResponse>
  signUpWithEmail(email: string, password: string): Promise<AuthResponse>
  signInWithWechat?(code: string): Promise<AuthResponse>
  signOut(): Promise<void>
  getCurrentUser(): Promise<User | null>
  isAuthenticated(): Promise<boolean>
}

// 国内使用 CloudBase
class CloudBaseAuthAdapter implements AuthAdapter {
  // 实现腾讯云认证逻辑
}

// 国际使用 Supabase
class SupabaseAuthAdapter implements AuthAdapter {
  // 实现 Supabase 认证逻辑
}
```

### 2. 认证客户端 (lib/auth/client.ts)

提供统一的前端认证 API：

```typescript
export const auth = {
  signInWithPassword: async (params) => { /* 登录 */ },
  signUp: async (params) => { /* 注册 */ },
  signOut: async () => { /* 登出 */ },
  getUser: async () => { /* 获取用户 */ },
  getSession: async () => { /* 获取会话 */ }
}
```

### 3. 登录页面 (app/login/page.tsx)

功能特性：
- 邮箱密码登录表单
- 表单验证和错误处理
- 微信登录集成
- 密码显示/隐藏切换
- 响应式设计

核心代码结构：
```typescript
export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const validateForm = () => {
    // 表单验证逻辑
  }

  const onSubmit = async (e: React.FormEvent) => {
    // 登录处理逻辑
    const res = await signIn('credentials', {
      email,
      password,
      redirect: false
    })
  }

  return (
    <div className="min-h-screen flex items-center justify-center">
      <Card className="w-full max-w-md">
        {/* 登录表单 */}
        {/* 微信登录按钮 */}
      </Card>
    </div>
  )
}
```

### 4. 注册页面 (app/register/page.tsx)

功能特性：
- 用户名（可选）、邮箱、密码注册
- 密码确认验证
- 实时表单验证
- 注册成功后跳转登录

### 5. 微信登录组件 (components/wechat-login-button.tsx)

功能特性：
- 检测设备类型（PC/移动）
- PC端显示二维码
- 移动端直接跳转
- 轮询检查登录状态
- 自动环境检测

核心实现：
```typescript
export default function WechatLoginButton() {
  const handleLogin = async () => {
    // 获取登录链接
    const { url, ticketId } = await fetch('/api/auth/wechat/login-url')

    if (isMobile()) {
      // 移动端直接跳转
      window.location.href = url
    } else {
      // PC端显示二维码并轮询
      setQrCodeUrl(qrCodeApiUrl)
      startPolling(ticketId)
    }
  }

  const startPolling = (ticketId: string) => {
    // 轮询检查登录状态
    setInterval(async () => {
      const res = await fetch(`/api/auth/wechat/poll?ticketId=${ticketId}`)
      if (data.status === 'success') {
        await signIn('wechat-login', { userId: data.userId })
      }
    }, 2000)
  }
}
```

## API 接口设计

### 1. 注册接口
```
POST /api/register
Content-Type: application/json

Request Body:
{
  "name": "用户名", // 可选
  "email": "user@example.com",
  "password": "password123"
}

Response:
{
  "success": true,
  "user": { "id": "xxx", "email": "user@example.com" }
}
```

### 2. 登录接口
```
POST /api/auth/login
Content-Type: application/json

Request Body:
{
  "email": "user@example.com",
  "password": "password123"
}

Response:
{
  "success": true,
  "user": { "id": "xxx", "email": "user@example.com" },
  "session": { "token": "jwt-token" }
}
```

### 3. 微信登录接口
```
GET /api/auth/wechat/login-url

Response:
{
  "url": "https://open.weixin.qq.com/...",
  "ticketId": "ticket-xxx"
}

GET /api/auth/wechat/poll?ticketId=xxx

Response:
{
  "status": "success", // success|pending|expired
  "userId": "user-xxx" // 仅成功时返回
}
```

## 环境配置

### 环境变量配置 (.env.local)

```bash
# NextAuth 配置
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key

# 腾讯云 CloudBase 配置（国内）
TENCENT_SECRET_ID=your-secret-id
TENCENT_SECRET_KEY=your-secret-key
TENCENT_ENV_ID=your-env-id

# Supabase 配置（国际）
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-key

# 微信开放平台配置
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret
```

## 部署说明

### 1. 依赖安装
```bash
# 使用 pnpm 安装依赖
pnpm install

# 或使用 npm
npm install
```

### 2. 环境配置
1. 复制 `.env.example` 为 `.env.local`
2. 填入相应的环境变量
3. 根据部署区域配置相应的认证服务

### 3. 数据库配置
- **国内部署**: 配置腾讯云 CloudBase
- **国际部署**: 配置 Supabase 项目

### 4. 微信登录配置
1. 在微信开放平台创建应用
2. 配置授权回调域名
3. 获取 AppID 和 AppSecret
4. 配置相应的环境变量

### 5. 部署命令
```bash
# 构建项目
npm run build

# 启动生产服务器
npm start

# 或使用 Vercel 部署
vercel --prod
```

## 开发指南

### 1. 添加新的认证方式

1. 在 `lib/auth/adapter.ts` 中实现新的适配器
2. 在 `lib/auth/client.ts` 中添加相应的客户端方法
3. 创建相应的组件和 API 接口

### 2. 自定义UI组件

项目使用 shadcn/ui 组件库，可以通过以下方式添加新组件：

```bash
npx shadcn-ui@latest add button
npx shadcn-ui@latest add input
```

### 3. 表单验证

使用 Zod 进行表单验证：

```typescript
import { z } from 'zod'

const loginSchema = z.object({
  email: z.string().email('请输入有效的邮箱地址'),
  password: z.string().min(6, '密码至少需要6个字符')
})
```

### 4. 错误处理

统一的错误处理机制：

```typescript
// API 错误响应
{
  "success": false,
  "error": "错误信息"
}

// 前端错误处理
const [error, setError] = useState<string | null>(null)

if (!response.ok) {
  setError(data.error || '操作失败')
}
```

## 常见问题

### 1. 微信登录不成功
- 检查微信开放平台配置
- 确认回调域名配置正确
- 检查 AppID 和 AppSecret 是否正确

### 2. 邮箱验证失败
- 检查邮箱格式验证正则表达式
- 确认 SMTP 服务配置（如需要）

### 3. 部署后认证失败
- 检查环境变量配置
- 确认数据库连接配置
- 检查 CORS 设置

### 4. 性能优化
- 使用 React.memo 优化组件渲染
- 实现适当的缓存策略
- 优化 API 响应时间

## 扩展功能

### 1. 添加第三方登录
可以添加以下第三方登录：
- Google OAuth（国际版）
- GitHub OAuth（国际版）
- QQ 登录（国内版）
- 微博登录（国内版）

### 2. 增强安全特性
- 两步验证 (2FA)
- 邮箱验证
- 手机号验证
- 登录设备管理

### 3. 用户体验优化
- 社会化登录
- 记住登录状态
- 密码重置功能
- 账户安全设置

## 总结

该登录注册系统提供了完整的用户认证解决方案，具有良好的可扩展性和维护性。通过适配器模式支持多种认证服务，适合不同地区的部署需求。代码结构清晰，文档完善，便于后续功能扩展和维护。